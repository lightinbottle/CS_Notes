# 分布式

## 分布式锁

* 分布式锁实现方式： Redis Zookeeper

### Redis

* SETNX (set if not exist) 

  插入一个键值对，如果key存在，插入失败（加锁失败）返回false，否则返回true

  可以设置一个过期时间，防止释放锁失败

* RedLock算法

  在多个redis实例上实现分布式锁，解决了setnx会出现的单点故障问题

  尝试从N个独立的redis实例上获取锁，当在大多数（大于等于（N/2+1））实例上获取了锁，那么久加锁成功，释放锁的时候需要在每个实例上释放；

### Zookeeper

开源的分布式协调服务

ZooKeeper 是一个典型的分布式数据一致性解决方案，分布式应用程序可以基于 ZooKeeper 实现诸如**数据发布/订阅、负载均衡、命名服务、分布式协调/通知、集群管理、Master 选举、分布式锁和分布式队列**等功能。

* Session

  Session 指的是 ZooKeeper 服务器与客户端会话。在 ZooKeeper 中，一个客户端连接是指客户端和服务器之间的一个 TCP **长连接**。 通过心跳保持会话，给服务器发送请求接受响应，接受服务器的通知。

  服务器给每个客户端分配一个sessionID,保证sessionID的全局唯一。

* 数据模型

  Zookeeper提供一种树形结构的共享的命名空间，以/为根节点；每个节点对应于zookeeper中的数据寄存器**ZNODE**

* **ZONDE类型**

  - 永久节点：不会因为Session会话结束或者超时而消失；
  - 临时节点：如果会话结束或者超时就会消失；
  - 有序节点：会在节点名的后面加一个数字后缀，并且是有序的，例如生成的有序节点为 /lock/node-0000000000，它的下一个有序节点则为 /lock/node-0000000001，以此类推。

* **Watcher**

  事件监听器，客户端可以在指定的zookeeper节点上注册监听器，当特定事件触发的时候，zookeeper可以将事件通知到具体的客户端上

* 集群架构

  zookeeper中集群有三种角色：Leader Follower Observer

  当leader宕机以后，follower会参与到leader的选举中

* ZAB协议 

  ZAB是zookeeper用来实现**分布式数据一致性**的协议，有两种模式：崩溃恢复 消息广播

* 一致性

  **一致性**指的是多个数据副本是否能保持一致的特性，在一致性的条件下，系统在执行数据更新操作之后能够<u>从一致性状态转移到另一个一致性状态</u>。 

  基于**状态机复制**实现分布式的数据一致性，必须保证消息的全序，所以要有一个leader；

  分布式数据一致性算法：Paxos(Paxos不能保证消息全序)  但是在Paxos基础之上改进的PacificA算法，zookeeper的ZAB算法都解决了消息全序的问题

* 分布式锁的实现

  - 创建一个锁目录 /lock；
  - 当一个客户端需要获取锁时，在 /lock 下创建临时的且有序的子节点；
  - 客户端获取 /lock 下的子节点列表，判断自己创建的子节点是否为当前子节点列表中序号最小的子节点，如果是则认为获得锁；否则监听自己的前一个子节点，获得子节点的变更通知后重复此步骤直至获得锁；
  - 执行业务代码，完成后，删除对应的子节点。

* 



